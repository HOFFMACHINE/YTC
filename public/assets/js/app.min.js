(function ()
{
    'use strict';

    angular.module('app', [
        'app.index'
    ]);
})();

(function ()
{
    'use strict';

    angular.module('app.index', [
        'ng-token-auth',
        '720kb.socialshare',
        'ngclipboard',
        'ui-rangeSlider'
    ]);
})();

(function ()
{
    'use strict';

    angular.module('app.index')
           .controller('IndexController', IndexController);

    IndexController.$inject = ['$auth', '$sce', '$interval', '$timeout', 'api'];

    function IndexController($auth, $sce, $interval, $timeout, api)
    {
        var vm = this;

        vm.error           = '';
        vm.user            = $auth.user;
        vm.video           = [];
        vm.fragment        = [];
        vm.active_fragment = [];
        vm.results         = [];
        vm.secret_admin    = [];

        vm.login               = login;
        vm.logout              = logout;
        vm.getUserFragments    = getUserFragments;
        vm.createVideo         = createVideo;
        vm.downloadVideo       = downloadVideo;
        vm.uploadVideo         = uploadVideo;
        vm.getVideoStatus      = getVideoStatus;
        vm.getVideoError       = getVideoError;
        vm.getVideoEmbedUrl    = getVideoEmbedUrl;
        vm.newFragment         = newFragment;
        vm.setActiveFragment   = setActiveFragment;
        vm.createFragment      = createFragment;
        // vm.previewFragment     = previewFragment;
        vm.deleteFragment      = deleteFragment;
        vm.uploadFragment      = uploadFragment;
        vm.getFragmentStatus   = getFragmentStatus;
        vm.getFragmentError    = getFragmentError;
        vm.getFragmentUrl      = getFragmentUrl;
        vm.getFragmentEmbedUrl = getFragmentEmbedUrl;
        vm.getAdminController  = getAdminController;

        /*
         |--------------------------------------------------------------------------------------------------------------
         | Auth
         |--------------------------------------------------------------------------------------------------------------
         */

        function login()
        {
            $auth.authenticate('google');
        }

        function logout()
        {
            $auth.signOut();
        }

        /*
         |--------------------------------------------------------------------------------------------------------------
         | Admin
         |--------------------------------------------------------------------------------------------------------------
         */

        function getAdminController()
        {
            var data = {
                token: vm.user.access_token
            };

            api.getAdminController(data).then(function (data)
            {
                vm.secret_admin = data;
            });
        }

        /*
         |--------------------------------------------------------------------------------------------------------------
         | Users
         |--------------------------------------------------------------------------------------------------------------
         */

        function getUserFragments()
        {
            var data = {
                id: vm.user.id
            };

            api.getUserFragments(data).then(function (data)
            {
                vm.user.fragments = data;
            });
        }

        /*
         |--------------------------------------------------------------------------------------------------------------
         | Videos
         |--------------------------------------------------------------------------------------------------------------
         */

        function createVideo()
        {
            var data = {
                url: vm.video.url
            };

            api.createVideo(data).then(function (data)
            {
                vm.video = data;
                vm.video.isCreated = true;

                vm.fragment.start_from  = 0;
                vm.fragment.end_from    = vm.video.duration;
                vm.fragment.title       = vm.video.title;
                vm.fragment.description = vm.video.description;

                getVideoEmbedUrl();
            });
        }

        function setActiveFragment(fragment)
        {
            vm.active_fragment = fragment;

            var data = {
                id: vm.active_fragment.id
            };

            api.getFragmentEmbedUrl(data).then(function (data)
            {
                vm.active_fragment.embed_url = $sce.trustAsResourceUrl(data.embed_url);
            });
        }

        function deleteFragment()
        {
            var data = {
                id: vm.active_fragment.id
            };

            api.deleteFragment(data).then(function ()
            {
                getUserFragments();
            });
        }

        function downloadVideo()
        {
            var data = {
                id: vm.video.id
            };

            api.downloadVideo(data).then(function (data)
            {
                vm.video.job_id = data.job_id;

                var status = $interval(function ()
                {
                    if (vm.video.status == 'error')
                    {
                        getVideoError();
                        newFragment();

                        $interval.cancel(status);
                    }

                    if (vm.video.status == 'downloaded')
                    {
                        uploadVideo();

                        $interval.cancel(status);
                    }

                    if (vm.video.status == 'uploaded')
                    {
                        uploadFragment();

                        $interval.cancel(status);
                    }

                    getVideoStatus();
                }, 5000);
            });
        }

        function uploadVideo()
        {
            var data = {
                id: vm.video.id
            };

            api.uploadVideo(data).then(function (data)
            {
                vm.video.job_id = data.job_id;

                var status = $interval(function ()
                {
                    if (vm.video.status == 'error')
                    {
                        getVideoError();
                        newFragment();

                        $interval.cancel(status);
                    }

                    if (vm.video.status == 'uploaded')
                    {
                        uploadFragment();

                        $interval.cancel(status);
                    }

                    getVideoStatus();
                }, 5000);
            });
        }

        function getVideoEmbedUrl()
        {
            var data = {
                id: vm.video.id,
                start_from: vm.fragment.start_from,
                end_from: vm.fragment.end_from
            };

            api.getVideoEmbedUrl(data).then(function (data)
            {
                vm.video.embed_url = $sce.trustAsResourceUrl(data.embed_url);
            });
        }

        function getVideoStatus()
        {
            var data = {
                id: vm.video.id,
                job_id: vm.video.job_id
            };

            api.getVideoStatus(data).then(function (data)
            {
                vm.video.status = data.status;
            });
        }

        function getVideoError()
        {
            var data = {
                id: vm.video.id
            };

            api.getVideoError(data).then(function (data)
            {
                vm.error = data.error;
            });
        }

        /*
         |--------------------------------------------------------------------------------------------------------------
         | Fragments
         |--------------------------------------------------------------------------------------------------------------
         */

        function newFragment()
        {
            vm.error    = '';
            vm.video    = [];
            vm.fragment = [];
        }

        function createFragment()
        {
            var data = {
                user_id: vm.user.id,
                video_id: vm.video.id,
                start_from: vm.fragment.start_from,
                end_from: vm.fragment.end_from,
                title: vm.fragment.title,
                description: vm.fragment.description
            };

            api.createFragment(data).then(function (data)
            {
                vm.fragment = data;
                vm.fragment.isCreating = true;

                downloadVideo();
            });
        }

        function uploadFragment()
        {
            var data = {
                id: vm.fragment.id
            };

            api.uploadFragment(data).then(function (data)
            {
                vm.fragment.job_id = data.job_id;

                var status = $interval(function ()
                {
                    if (vm.fragment.status == 'error')
                    {
                        getFragmentError();
                        newFragment();

                        $interval.cancel(status);
                    }

                    if (vm.fragment.status == 'uploaded')
                    {
                        getFragmentUrl();

                        $timeout(function ()
                        {
                            vm.video.isCreated = false;
                            vm.fragment.isCreating = false;
                            vm.fragment.isCreated = true;
                        }, 5000);

                        $interval.cancel(status);
                    }

                    getFragmentStatus();
                }, 5000);
            });
        }

        function getFragmentStatus()
        {
            var data = {
                id: vm.fragment.id,
                job_id: vm.fragment.job_id
            };

            api.getFragmentStatus(data).then(function (data)
            {
                vm.fragment.status = data.status;
            });
        }

        function getFragmentError()
        {
            var data = {
                id: vm.fragment.id
            };

            api.getFragmentError(data).then(function (data)
            {
                vm.error = data.error;
            });
        }

        function getFragmentUrl()
        {
            var data = {
                id: vm.fragment.id
            };

            api.getFragmentUrl(data).then(function (data)
            {
                vm.fragment.url = data.url;

                getFragmentEmbedUrl();
            });
        }

        function getFragmentEmbedUrl()
        {
            var data = {
                id: vm.fragment.id
            };

            api.getFragmentEmbedUrl(data).then(function (data)
            {
                vm.fragment.embed_url = $sce.trustAsResourceUrl(data.embed_url);
            });
        }
    }
})();

(function ()
{
    'use strict';

    angular.module('app')
           .config(authConfig)

    authConfig.$inject = ['$authProvider'];

    function authConfig($authProvider)
    {
        $authProvider.configure({
            apiUrl: '/api'
        });
    }
})();

(function ()
{
    'use strict';

    angular.module('app.index')
           .factory('api', api);

    api.$inject = ['$http'];

    function api($http)
    {
        return {
            "getAdminController": getAdminController,
            "getUserFragments": getUserFragments,
            "createVideo": createVideo,
            "downloadVideo": downloadVideo,
            "uploadVideo": uploadVideo,
            "getVideoEmbedUrl": getVideoEmbedUrl,
            "getVideoStatus": getVideoStatus,
            "getVideoError": getVideoError,
            "createFragment": createFragment,
            "deleteFragment": deleteFragment,
            "uploadFragment": uploadFragment,
            "getFragmentUrl": getFragmentUrl,
            "getFragmentEmbedUrl": getFragmentEmbedUrl,
            "getFragmentStatus": getFragmentStatus,
            "getFragmentError": getFragmentError
        };

        /*
         |--------------------------------------------------------------------------------------------------------------
         | Admin
         |--------------------------------------------------------------------------------------------------------------
         */

        function getAdminController(data)
        {
            return $http.post('/api/admin/secret', data).then(function (response)
            {
                return response.data;
            });
        }

        /*
         |--------------------------------------------------------------------------------------------------------------
         | Users
         |--------------------------------------------------------------------------------------------------------------
         */

        function getUserFragments(data)
        {
            return $http.get('/api/users/' + data.id + '/fragments').then(function (response)
            {
                return response.data;
            });
        }

        /*
         |--------------------------------------------------------------------------------------------------------------
         | Videos
         |--------------------------------------------------------------------------------------------------------------
         */

        function createVideo(data)
        {
            return $http.post('/api/videos', data).then(function (response)
            {
                return response.data;
            });
        }

        function downloadVideo(data)
        {
            return $http.get('/api/videos/' + data.id + '/download').then(function (response)
            {
                return response.data;
            });
        }

        function uploadVideo(data)
        {
            return $http.get('/api/videos/' + data.id + '/upload').then(function (response)
            {
                return response.data;
            });
        }

        function getVideoEmbedUrl(data)
        {
            return $http.post('/api/videos/' + data.id + '/embed_url', data).then(function (response)
            {
                return response.data;
            });
        }

        function getVideoStatus(data)
        {
            return $http.post('/api/videos/' + data.id + '/status', data).then(function (response)
            {
                return response.data;
            });
        }

        function getVideoError(data)
        {
            return $http.get('/api/videos/' + data.id + '/error').then(function (response)
            {
                return response.data;
            });
        }

        /*
         |--------------------------------------------------------------------------------------------------------------
         | Fragments
         |--------------------------------------------------------------------------------------------------------------
         */

        function createFragment(data)
        {
            return $http.post('/api/fragments', data).then(function (response)
            {
                return response.data;
            });
        }

        function deleteFragment(data)
        {
            return $http.delete('/api/fragments/' + data.id).then(function (response)
            {
                return response.data;
            });
        }

        function uploadFragment(data)
        {
            return $http.get('/api/fragments/' + data.id + '/upload').then(function (response)
            {
                return response.data;
            });
        }

        function getFragmentUrl(data)
        {
            return $http.get('/api/fragments/' + data.id + '/url').then(function (response)
            {
                return response.data;
            });
        }

        function getFragmentEmbedUrl(data)
        {
            return $http.get('/api/fragments/' + data.id + '/embed_url').then(function (response)
            {
                return response.data;
            });
        }

        function getFragmentStatus(data)
        {
            return $http.post('/api/fragments/' + data.id + '/status', data).then(function (response)
            {
                return response.data;
            });
        }

        function getFragmentError(data)
        {
            return $http.get('/api/fragments/' + data.id + '/error').then(function (response)
            {
                return response.data;
            });
        }
    }
})();

(function()
{
    'use strict';

    angular.module('app.index')
           .directive('appTab', appTab);

    function appTab()
    {
        return {
            restrict: 'A',
            link: link
        };

        function link(scope, element, attributes)
        {
            $(element).tab();
        }
    }
})();

(function()
{
    'use strict';

    angular.module('app.index')
        .directive('appModal', appModal);

    function appModal()
    {
        return {
            restrict: 'A',
            link: link
        };

        function link(scope, element, attributes)
        {
            $(element).on('click', function()
            {
                var modal = $(attributes.modalId);

                modal.modal
                ({
                    onHide: function()
                    {
                        modal.find('iframe').attr('src', modal.find('iframe').attr('src'));
                    },
                    selector: {
                        close : '.close'
                    }
                }).modal('show');
            })
        }
    }
})();

//# sourceMappingURL=app.min.js.map
